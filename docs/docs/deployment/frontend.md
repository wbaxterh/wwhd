# Frontend Deployment Guide

## Overview
This guide covers deploying the W.W.H.D. frontend to AWS Amplify. The frontend uses Next.js with static export mode for compatibility with Amplify hosting.

## Prerequisites
- AWS Amplify app configured
- Source code with latest changes
- Access to create deployment archives

## Configuration Requirements

### Next.js Configuration (`next.config.js`)
The frontend must use static export mode for Amplify compatibility:

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  typescript: {
    ignoreBuildErrors: true,
  },
  output: 'export',           // Required for static export
  trailingSlash: true,        // Required for proper routing
  images: {
    unoptimized: true,        // Required for static export
  },
}

module.exports = nextConfig
```

### Amplify Build Configuration (`amplify.yml`)
The build configuration must create the `_redirects` file for client-side routing:

```yaml
version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
    build:
      commands:
        - npm run build
        - echo "/*    /index.html   200" > out/_redirects  # Critical for SPA routing
  artifacts:
    baseDirectory: out        # Static export output directory
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
```

## Deployment Process

### ⚠️ Important: Use Static File Deployment (Verified Working Method)

**Deploy pre-built static files, NOT source code.** The source code build method has been experiencing issues with Amplify not properly executing the build process.

### Working Method: Static File Deployment

#### Step 1: Build and Prepare Static Files
```bash
# Navigate to frontend directory
cd /path/to/wwhd/frontend

# Build the frontend
npm run build

# CRITICAL: Create the _redirects file for SPA routing
echo "/*    /index.html   200" > out/_redirects
```

#### Step 2: Create Static Deployment Archive
```bash
# Navigate to the built output directory
cd out

# Create deployment zip with static files (replace YYYYMMDD-HHMM with current timestamp)
zip -r ../../frontend-static-$(date +%Y%m%d-%H%M).zip .

# Return to project root
cd ../..
```

#### Step 3: Upload to Amplify
1. Go to AWS Amplify Console
2. Select your app
3. Choose "Deploy without Git provider" or manual deployment
4. Upload the `frontend-static-YYYYMMDD-HHMM.zip` file (NOT the source code zip)
5. Deployment should complete in ~8 seconds (no build needed)

### Alternative Method: Source Code Deployment (Currently Not Recommended)

If you need to deploy source code for Amplify to build:

```bash
# Navigate to project root
cd /path/to/wwhd

# Create deployment zip (replace YYYYMMDD-HHMM with current timestamp)
zip -r frontend-deployment-$(date +%Y%m%d-%H%M).zip frontend/ \
  -x "frontend/node_modules/*" \
     "frontend/.next/*" \
     "frontend/out/*" \
     "frontend/.env*" \
     "frontend/.git*" \
     "frontend/*.zip"
```

**Note:** This method requires Amplify to properly read and execute the `amplify.yml` build configuration, which has been inconsistent. Use the static file method above for reliable deployments.

## Critical Elements for Success

### The `_redirects` File
The most important element is the `_redirects` file created during build:
```
/*    /index.html   200
```

This file:
- **Purpose**: Enables client-side routing for Single Page Application (SPA)
- **Function**: Tells Amplify to serve `index.html` for all routes
- **Location**: Must be in the `out/` directory after build
- **Creation**: Automatically generated by the build command in `amplify.yml`

### Static Export Mode
- **Requirement**: Next.js must use `output: 'export'`
- **Reason**: Amplify hosting works best with static files
- **Trade-off**: No server-side features, but enables fast global distribution

## Troubleshooting

### 404 Errors on Page Refresh
**Problem**: Getting 404 errors when refreshing pages or accessing routes directly

**Solution**: Ensure the `_redirects` file is being created properly
```bash
# Check if build command creates _redirects file
npm run build
ls -la out/_redirects  # Should exist with content: /*    /index.html   200
```

### Build Failures
**Problem**: Build fails on Amplify

**Common causes and solutions**:
- **Missing dependencies**: Ensure `package-lock.json` is included
- **TypeScript errors**: Set `ignoreBuildErrors: true` in `next.config.js`
- **Environment variables**: Configure in Amplify console if needed

### Routing Issues
**Problem**: Internal navigation doesn't work

**Solution**: Verify configuration matches exactly:
- `output: 'export'` in `next.config.js`
- `trailingSlash: true` in `next.config.js`
- `baseDirectory: out` in `amplify.yml`
- `_redirects` file creation in build process

## Features Included in Current Deployment

The current frontend includes:
- ✅ **Starter Questions**: Three sample questions appear when chat is empty
- ✅ **Auto-send**: Clicking starter questions automatically submits them
- ✅ **Dark/Light Mode**: Theme toggle functionality
- ✅ **YouTube Links**: Clickable YouTube URLs in chat citations
- ✅ **Authentication**: Login/logout functionality
- ✅ **Knowledge Base Management**: Document upload and management
- ✅ **Responsive Design**: Works on mobile and desktop

## Deployment Checklist

Before deploying:
- [ ] `next.config.js` has correct static export configuration
- [ ] `amplify.yml` includes `_redirects` file creation
- [ ] Latest changes are included in deployment zip
- [ ] No build artifacts (node_modules, .next, out) in zip
- [ ] Environment variables configured in Amplify (if needed)

After deploying:
- [ ] Build completed successfully in Amplify console
- [ ] Homepage loads correctly
- [ ] All routes work (chat, knowledgebase)
- [ ] Page refresh doesn't cause 404 errors
- [ ] Starter questions appear and function
- [ ] Backend API connectivity works

## Environment Configuration

### Production Backend URL
Ensure the frontend is configured to connect to the correct backend:
- **File**: `src/config/api.ts`
- **Production URL**: `http://wwhd-alb-1530831557.us-west-2.elb.amazonaws.com`
- **Local URL**: `http://localhost:8000` (for development)

### Amplify Environment Variables
If using environment variables, configure them in Amplify console:
- Go to App Settings > Environment variables
- Add any required variables (e.g., `NEXT_PUBLIC_API_URL`)

## File Structure
The deployment should include these key files:
```
frontend/
├── amplify.yml              # Build configuration
├── next.config.js           # Next.js configuration
├── package.json             # Dependencies
├── package-lock.json        # Dependency lock
├── tailwind.config.js       # Styling
├── tsconfig.json           # TypeScript config
└── src/
    ├── app/                # Pages
    ├── components/         # React components
    ├── config/            # Configuration
    └── contexts/          # React contexts
```

## Success Criteria
A successful deployment should:
1. Build without errors in Amplify console
2. Serve the homepage at the Amplify URL
3. Allow navigation to all routes (/chat, /knowledgebase)
4. Handle page refreshes without 404 errors
5. Display starter questions on empty chat
6. Connect to backend API successfully